# docker-compose.yml

services:
  # 1. MongoDB 서비스 (데이터베이스)
  mongo:
    image: mongo:latest # MongoDB 최신 버전을 사용
    container_name: mongodb_container
    ports:
      - '27017:27017' # [내 PC 포트]:[컨테이너 포트]
    volumes:
      - mongodb_data:/data/db # [볼륨 이름]:[컨테이너 내부 데이터 경로]
    environment:
      MONGO_INITDB_ROOT_USERNAME: root # ⬅️ 관리자 ID (원하는대로 변경)
      MONGO_INITDB_ROOT_PASSWORD: password # ⬅️ 관리자 PW (원하는대로 변경)
    restart: unless-stopped

  # 2. Redis 서비스 (Celery 메시지 큐)
  # redis:
  #   image: redis:latest # Redis 최신 버전을 사용
  #   container_name: redis_container
  #   ports:
  #     - '6379:6379' # [내 PC 포트]:[컨테이너 포트]
  #   volumes:
  #     - redis_data:/data
  #   restart: unless-stopped
  # 3. Mongo Express (MongoDB 웹 인터페이스) - ⬅️ 이 부분이 추가되었습니다.
  mongo-express:
    image: mongo-express:latest # Mongo Express 최신 버전
    container_name: mongo_express_container
    ports:
      - '8081:8081' # [내 PC 포트]:[컨테이너 포트] (8081로 접속)
    environment:
      ME_CONFIG_MONGODB_SERVER: mongo # ⬅️ 연결할 몽고DB (서비스 이름 'mongo'를 사용)
      ME_CONFIG_MONGODB_ADMINUSERNAME: root # ⬅️ 1번 mongo의 관리자 ID와 일치
      ME_CONFIG_MONGODB_ADMINPASSWORD: password # ⬅️ 1번 mongo의 관리자 PW와 일치
      ME_CONFIG_BASICAUTH_USERNAME: admin # ⬅️ 웹 UI 로그인 ID (원하는대로 변경)
      ME_CONFIG_BASICAUTH_PASSWORD: admin1234 # ⬅️ 웹 UI 로그인 PW (원하는대로 변경)
    depends_on:
      - mongo # ⬅️ 'mongo' 서비스가 먼저 실행된 후 실행
    restart: unless-stopped
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant_vector_db
    ports:
      - '6333:6333' # HTTP API 포트
      - '6334:6334' # gRPC 포트
    volumes:
      - qdrant_storage:/qdrant/storage # 데이터 영구 저장

  # 4. Python 애플리케이션 (Poetry 기반)
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rag_python_app
    env_file:
      - .env
    environment:
      # 컨테이너 내부에서 사용할 기본 연결 URL (필요 시 .env 에서 오버라이드)
      MONGO_URI: 'mongodb://root:password@mongo:27017/?authSource=admin'
      QDRANT_URL: 'http://qdrant:6333'
    ports:
      - '8002:8002' # FastAPI 기본 포트 매핑
    command:
      [
        'uvicorn',
        'src.application.main:app',
        '--host',
        '0.0.0.0',
        '--port',
        '8002',
      ]
    volumes:
      - ./:/app # 로컬 소스 코드 마운트 (개발 편의)
      - poetry_cache:/root/.cache/pypoetry # Poetry 캐시 공유로 빌드 가속
    depends_on:
      - mongo
      - qdrant
    # 초기에는 컨테이너를 켜둔 채로 개발을 쉽게 하기 위해 대기 상태로 둡니다.
    # 실제 실행 스크립트가 생기면 아래 명령을 원하는 것으로 바꾸세요.
    restart: unless-stopped

# 4. 데이터 보존을 위한 Docker 볼륨 정의
volumes:
  mongodb_data: {}
  # redis_data: {}
  qdrant_storage: {} # qdrant 데이터용 볼륨
  poetry_cache: {}
